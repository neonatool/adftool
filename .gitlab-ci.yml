variables:
  GIT_SUBMODULE_STRATEGY: recursive

pages:
  script:
    - apt-get update -y
    - apt-get install -y git python gettext libhdf5-dev zlib1g-dev autoconf autoconf-archive automake libtool valgrind tar global autopoint make gcc g++ cmake m4 libtinfo5 wine wine64 mingw-w64 binutils-mingw-w64 gcc-mingw-w64 g++-mingw-w64
    - git clone https://github.com/emscripten-core/emsdk.git
    - cd emsdk
    - ./emsdk install latest
    - ./emsdk activate latest
    - source ./emsdk_env.sh
    - cd ..
    - export GNULIB_SRCDIR=$PWD/gnulib
    - mkdir build-hdf5-with-node build-hdf5-emscripten build-hdf5-mingw32 build-hdf5-mingw64
    - cd hdf5
    - ln -s /usr/bin/libtoolize ./libtoolize
    - cp src/H5make_libsettings.c src/H5make_libsettings-original.c
    - "(echo '#define main true_main' ; cat src/H5make_libsettings.c ../H5make_libsettings_true_main.c) > src/H5make_libsettings.c-stdin"
    - cp src/H5make_libsettings.c-stdin src/H5make_libsettings.c
    - export HDF5_ACLOCAL=$(which aclocal) ; export HDF5_AUTOHEADER=$(which autoheader) ; export HDF5_AUTOMAKE=$(which automake) ; export HDF5_AUTOCONF=$(which autoconf) ; export HDF5_LIBTOOL=$(which libtool) ; export HDF5_M4=$(which m4) ; ./autogen.sh
    - cd ../build-hdf5-with-node
    - emconfigure ../hdf5/configure --enable-build-mode=production CFLAGS="-std=gnu11" LIBS="-lnodefs.js" --disable-tools --disable-tests
    - emmake make -k -j 8 || true
    - cd src
    - "cat libhdf5.settings | node ./H5make_libsettings > ../../hdf5/src/H5lib_settings.c-emscripten"
    - node ./H5detect > ../../hdf5/src/H5Tinit.c-emscripten
    - cd ../../hdf5
    - cp src/H5make_libsettings-original.c src/H5make_libsettings.c
    - cd ../build-hdf5-emscripten
    - emconfigure ../hdf5/configure --enable-build-mode=production --prefix=$PWD/../public/emscripten --disable-tools --disable-tests
    - emmake make -j 8 -k || true
    - cp ../hdf5/src/H5lib_settings.c-emscripten ../hdf5/src/H5lib_settings.c
    - cp ../hdf5/src/H5Tinit.c-emscripten ../hdf5/src/H5Tinit.c
    - emmake make -j 8
    - emmake make install
    - cd ../build-hdf5-mingw32
    - ../hdf5/configure --target=i686-w64-mingw32 --enable-build-mode=production --prefix=$PWD/../public/mingw32 --disable-tools --disable-tests
    - make -j 8 -k || true
    - cd src
    - wine ./H5make_libsettings.exe > ../../hdf5/src/H5lib_settings.c
    - wine ./H5detect.exe > ../../hdf5/src/H5Tinit.c
    - cd ..
    - make -j 8
    - make install
    - cd ../build-hdf5-mingw64
    - ../hdf5/configure --target=x86_64-w64-mingw32 --enable-build-mode=production --prefix=$PWD/../public/mingw64 --disable-tools --disable-tests
    - make -j 8 -k || true
    - cd src
    - wine64 ./H5make_libsettings.exe > ../../hdf5/src/H5lib_settings.c
    - wine64 ./H5detect.exe > ../../hdf5/src/H5Tinit.c
    - cd ..
    - make -j 8
    - make install
    - cd ..
    - ./bootstrap --force --skip-po
    - ./configure CPPFLAGS=-I/usr/include/hdf5/serial LDFLAGS=-L/usr/lib/x86_64-linux-gnu/hdf5/serial
    - make -j
    - make -j check
    - make -j distcheck DISTCHECK_CONFIGURE_FLAGS="CPPFLAGS=-I/usr/include/hdf5/serial LDFLAGS=-L/usr/lib/x86_64-linux-gnu/hdf5/serial"
    - cp adftool-*.tar.gz public/adftool-latest.tar.gz
    - make distclean
    - mkdir -p build-adftool-emscripten
    - cd build-adftool-emscripten
    - emconfigure ../configure CPPFLAGS=-I$PWD/../public/emscripten/include LIBS=$PWD/../public/emscripten/lib/libhdf5.a --prefix=$PWD/../public/emscripten
    - emmake make -j
    - emmake make install
    - ./libtool --tag=CC --mode=link emcc -O3 libadftool.la -o index.html
    - ls -R .libs
    - cp -R .libs/ ../public
  artifacts:
    paths:
      - public